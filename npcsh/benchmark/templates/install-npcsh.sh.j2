#!/bin/bash
# Installation script for npcsh in Terminal-Bench containers
# This template is rendered by Harbor before execution

set -e

echo "Installing npcsh for Terminal-Bench evaluation..."

# Install Python dependencies if needed
if ! command -v pip &> /dev/null; then
    echo "Installing pip..."
    apt-get update && apt-get install -y python3-pip
fi

# Upgrade pip first to handle modern packages and extras
echo "Upgrading pip..."
pip install --upgrade pip 2>/dev/null || pip install --break-system-packages --upgrade pip 2>/dev/null || true

# Install from local source (uploaded by agent setup)
echo "Installing npcpy from local source..."
if [ -d /src/npcpy ]; then
    pip install --break-system-packages -e /src/npcpy 2>/dev/null || pip install -e /src/npcpy
fi

echo "Installing npcsh from local source..."
pip install --break-system-packages -e /src/npcsh ollama 2>/dev/null || pip install -e /src/npcsh ollama

# Verify installation
echo "Verifying npcsh installation..."
npc --help > /dev/null 2>&1 || {
    echo "ERROR: npcsh installation failed"
    exit 1
}

# Set up default configuration
export NPCSH_STREAM_OUTPUT=0
export NPCSH_LOG_LEVEL=warning

{% if version %}
echo "npcsh version: {{ version }}"
{% endif %}

echo "npcsh installation complete!"
